{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/2018-07-21/dragino-lorashield-on-AU915/","result":{"data":{"site":{"siteMetadata":{"title":"Thomas Laurenson"}},"markdownRemark":{"id":"0980df65-e66b-535b-994e-530228c9a215","excerpt":"This post summarizes an updated tutorial on how to configure the Dragino LoRa Shield device for the Australian/New Zealand (AU915) frequency using my fork of…","html":"<p>This post summarizes an updated tutorial on how to configure the Dragino LoRa Shield device for the Australian/New Zealand (AU915) frequency using my fork of the MCCI Catena version of the Arduino-LMIC library. </p>\n<h2 id=\"contents\" style=\"position:relative;\"><a href=\"#contents\" aria-label=\"contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Contents</h2>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#background\">Background</a></li>\n<li><a href=\"#quickstart\">Quickstart</a></li>\n<li><a href=\"#arduino-environment-setup\">Arduino Environment Setup</a></li>\n<li><a href=\"#mcci-arduino-lmic-library-configuration\">MCCI Arduino-LMIC Library Configuration</a></li>\n<li><a href=\"#sample-dragino-lora-shield-sketch\">Sample Dragino LoRa Shield Sketch</a></li>\n<li><a href=\"#conclusion\">Conclusion</a></li>\n</ul>\n</div>\n<h2 id=\"background\" style=\"position:relative;\"><a href=\"#background\" aria-label=\"background permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Background</h2>\n<p>I recently wrote a post about <a href=\"%7B%25%20post_url%202018-07-06-dragino-lorashield-node-configuration-for-AU915%20%25%7D\">Configuring a Dragino LoRa Shield for use on the AU915 frequency</a> so that the device can be used legally in New Zealand. Specifically, so that the device can operate on the AU915 regional configuration standard. The post linked to one of my GitHub repositories that used a modified version of the original <a href=\"https://github.com/matthijskooijman/arduino-lmic\">Arduino-LMIC library</a>, written by Matthijs Kooijman. However, this library does not support the AU915 frequency out-of-the-box, and my solution was a fork of the original project, followed by quite a <em>hacky</em> fix to define the AU915 frequency range and channel selection. It works, but is not exactly elegant!</p>\n<p>It seems that there are so many forks of the same <em>Arduino-LMIC</em> project that finding a reliable and suitable one (for specific devices and frequency requirements) is challenging. I am not complaining about the number of forks, I have a fork of the same library! Well, two now… Nevertheless, I discovered a fork authored by the <a href=\"https://github.com/mcci-catena\">MCCI Catena Corporation</a> on their GitHub site. They had forked it from <a href=\"https://github.com/things-nyc\">The Things Network New York</a>, who forked it from the original Arduino-LMIC library by Matthijs Kooijman. Anyway, the MCCI library appears to be actively developed and provided support for a large number of frequencies (regional configurations), including the well supported EU868 and US915 standards, as well as more recent standardization including AU915, AS923, and IN866. Excellent!</p>\n<p>OK, the interesting part. How can the MCCI <em>Arduino-LMIC</em> code be modified to run on a different regional configuration? It is relatively straight-forward and they do provide documentation on how to accomplish this task. However, it still took me a while to understand the most basic modifications required to get the code to run on the AU915 standard. The following sections outline the modifications required to use the AU915 configuration on a Dragino LoRa Shield. </p>\n<h4 id=\"my-arduino-lmic-library-fork\" style=\"position:relative;\"><a href=\"#my-arduino-lmic-library-fork\" aria-label=\"my arduino lmic library fork permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>My Arduino-LMIC Library Fork</h4>\n<p>I have forked the original <a href=\"https://github.com/mcci-catena/arduino-lmic\">MCCI Arduino-LMIC library</a> and pushed updates to my forked version. My forked version has sketches provided for the Dragino LoRa Shield and Adafruit Feather m0 LoRa boards to operate on AU915 sub-band 2. My forked repository is available from:</p>\n<ul>\n<li><a href=\"https://github.com/thomaslaurenson/arduino-lmic\">thomaslaurenson/arduino-lmic</a></li>\n</ul>\n<p>Initially, I didn’t want to fork the MCCI Arduino-LMIC library. I feel that there are so many forks, each with changes for: 1) To work on a specific frequency, or 2) To work with a specific device. However, putting all the code in one place seemed like a good solution. The future of my fork will be only to include new sketch files for specific devices or authentication method, and small changes to make the installation process easier for the end-user. I will try to pull updates from MCCI when necessary to keep the fork updated as well. If there is a major problem or changes with the AU915 code, I would rather submit a pull request to the actual MCCI fork of the project - who are doing an excellent job at updating code and fixing community issues. Well done MCCI!</p>\n<h2 id=\"quickstart\" style=\"position:relative;\"><a href=\"#quickstart\" aria-label=\"quickstart permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Quickstart</h2>\n<ul>\n<li>Download and install the Arduino IDE</li>\n<li>Add my fork of the MCCI Arduino-LMIC library to the <em>libraries</em> directory of your Arduino IDE installation</li>\n<li><em>Option 1:</em> Clone the Arduino-LMIC library into the <em>libraries</em> folder:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">git clone https://github.com/thomaslaurenson/arduino-lmic.git</code></pre></div>\n<ul>\n<li><em>Option 2:</em> Download the ZIP of the repository and use the  <em>Add .ZIP Library…</em> functionality in the Arduino IDE</li>\n<li>Copy the provided sketch for the Dragino LoRa Shield from the <code class=\"language-text\">examples</code> folder into the Arduino Sketchbook folder</li>\n<li>Open the sketch for your device, change your COM port to the attached device, and <em>Upload</em></li>\n<li>Check the <em>Serial Monitor</em> on baud <code class=\"language-text\">115200</code> to check the device is functioning</li>\n</ul>\n<p>If you require further information, please continue reading for a full explanation. </p>\n<h2 id=\"arduino-environment-setup\" style=\"position:relative;\"><a href=\"#arduino-environment-setup\" aria-label=\"arduino environment setup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Arduino Environment Setup</h2>\n<p>Make sure you have version 1.6.6 (or above) of the Arduino IDE. The documentation for the MCCI Arduino-LMIC library state that this version is required because it requires C99 mode to be enabled by default.</p>\n<p>Now we need to install the Arduino-LMIC library in our Arduino IDE environment. I think the easiest method is to download the GitHub repository as a ZIP file. This can be achieved using the following steps:</p>\n<ul>\n<li>Open a web browser and navigate to the <a href=\"https://github.com/thomaslaurenson/arduino-lmic\">MCCI Arduino-LMIC library</a> repository</li>\n<li>Click on the <em>Clone or Download</em> button</li>\n<li>Select <em>Download ZIP</em></li>\n<li>In the Arduino IDE, navigate to <em>Sketch</em>, <em>Include Library</em>, <em>Add .ZIP Library…</em></li>\n<li>Find the ZIP file, and select <em>Open</em></li>\n</ul>\n<p>Make sure you have the correct board selected in the Arduino IDE. If you are using the Dragino LoRa Shield, the board needs to be configured as an Arduino Uno (because it is an Arduino Uno shield). Make sure you select the correct board from the <em>Tools</em>, <em>Board</em> menu and select <em>Arduino Uno</em>.</p>\n<h2 id=\"mcci-arduino-lmic-library-configuration\" style=\"position:relative;\"><a href=\"#mcci-arduino-lmic-library-configuration\" aria-label=\"mcci arduino lmic library configuration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MCCI Arduino-LMIC Library Configuration</h2>\n<p>The only modification required to the library itself to use a different frequency is changing the defined regional configuration that the library uses. <strong>This step is not required if you used my forked version of the MCCI Arduino-LMIC library</strong>, however, I have documented the process I used below to be thorough.</p>\n<p>The regional configuration is set in the <code class=\"language-text\">lmic_project_config.h</code> file - found in the root folder of the library repository. The default value is <code class=\"language-text\">#define CFG_us915 1</code>. To modify this value, and replace it with another regional configuration we need to find and modify the <code class=\"language-text\">lmic_project_config.h</code> file. Depending on how you install the library in the Arduino IDE, how your Arduino IDE is configured, and what operating system you are using… this location may vary. The best method to find it is to determine the location using the Arduino IDE itself. The following steps will determine the location of the <em>Arduino-LMIC</em> library and change the regional configuration:</p>\n<ul>\n<li>In the Arduino IDE, navigate to <em>File</em>, <em>Preferences</em></li>\n<li>In the <em>Settings</em> tab, find the value of <em>Sketchbook location</em></li>\n<li>Open your file browser (e.g., Windows Explorer, Nautilus)</li>\n<li>Browse to the <em>Sketchbook location</em></li>\n<li>There should be a folder called <em>libraries</em></li>\n<li>You should find the library here, named: <code class=\"language-text\">arduino-lmic-master</code></li>\n<li>Open the library folder, then open the <code class=\"language-text\">project_config</code> folder</li>\n<li>Open <code class=\"language-text\">lmic_project_config.h</code> in a text editor</li>\n<li>Comment out the <code class=\"language-text\">#define CFG_us915 1</code> line (use a <code class=\"language-text\">//</code>)</li>\n<li>Un-comment any other regional configuration line</li>\n<li>For example: un-comment the  <code class=\"language-text\">#define CFG_au921 1</code> line if you want to use the AU921 configuration</li>\n<li>The final result should look like the code snippet below:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// project-specific definitions</span>\n<span class=\"token comment\">//#define CFG_eu868 1</span>\n<span class=\"token comment\">//#define CFG_us915 1</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CFG_au921</span> <span class=\"token expression\"><span class=\"token number\">1</span></span></span>\n<span class=\"token comment\">//#define CFG_as923 1</span>\n<span class=\"token comment\">//#define LMIC_COUNTRY_CODE LMIC_COUNTRY_CODE_JP    /* for as923-JP */</span>\n<span class=\"token comment\">//#define CFG_in866 1</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CFG_sx1276_radio</span> <span class=\"token expression\"><span class=\"token number\">1</span></span></span>\n<span class=\"token comment\">//#define LMIC_USE_INTERRUPTS</span></code></pre></div>\n<p><strong>NOTE:</strong> It is unusual that the MCCI code refers to the AU915 regional configuration as <em>AU921</em>. I have never seen the Australian/New Zealand standard referred to using this naming convention. Nevertheless, after reviewing the source code and testing two devices, this is the correct setting for configuring a node for use on the AU915 standard.</p>\n<p>All done! Compared to other libraries this is a very easy modification for AU915/AU921 support. The only other configuration can be done in the actual Arduino sketch, where we can specify that we want to use the AU915/AU921 channel plan and can select a specific sub-band as well. Now, we are ready to modify the default sketch provided in the project.</p>\n<h2 id=\"sample-dragino-lora-shield-sketch\" style=\"position:relative;\"><a href=\"#sample-dragino-lora-shield-sketch\" aria-label=\"sample dragino lora shield sketch permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Sample Dragino LoRa Shield Sketch</h2>\n<p>Similar to other <em>Arduino-LMIC</em> forks, and the original version, the MCCI fork is shipped with a collection of example scripts. For someone new to LoRaWAN, it can be very difficult to modify these examples to work with a specific device or frequency. This section discusses a specific sketch file I have authored for the Dragino LoRa Shield (named <code class=\"language-text\">ttn-abp-dragino-lorashield-au915.ino</code>) to operate on the AU915 frequency. The example sketch is located at:</p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">https://github.com/thomaslaurenson/arduino-lmic/blob/master/examples/ttn-abp-dragino-lorashield-au915/ttn-abp-dragino-lorashield-au915.ino</code></pre></div>\n<p>This sketch is based on the original sketch named <code class=\"language-text\">ttn-abp.ino</code> which is for use on The Things Network, using Activation by Personalisation, or ABP. The original example is available from the MCCI GitHub repository using this direct link to the <a href=\"https://github.com/mcci-catena/arduino-lmic/blob/master/examples/ttn-abp/ttn-abp.ino\">ttn-abp.ino</a> file. My sketch is configured for the following:</p>\n<ul>\n<li>Configured for AU915 </li>\n<li>Configured for sub-band 2</li>\n<li>Modified pin mapping for Dragino LoRa Shield</li>\n<li>Configured to authenticate using ABP</li>\n</ul>\n<h4 id=\"adding-the-example-sketch\" style=\"position:relative;\"><a href=\"#adding-the-example-sketch\" aria-label=\"adding the example sketch permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Adding the Example Sketch</h4>\n<p>The example sketch I have authored for the Dragino LoRa Shield is provided in the <code class=\"language-text\">examples</code> directory. The sketch is named:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ttn-abp-dragino-lorashield-au915.ino</code></pre></div>\n<p>There are many ways to get this sketch imported into the Arduino IDE. You can simply open the file from where ever you download the repository. The best method is to add it to the Arduino IDE sketchbook. Make sure to put the sketch (<code class=\"language-text\">.ino</code> file) into a folder with the same name.</p>\n<p>As it is, the sketch is ready to be compiled and uploaded. However, it is prudent to discuss the changes I made to the original sketch and why they were necessary.</p>\n<h4 id=\"frequency-operation-definition\" style=\"position:relative;\"><a href=\"#frequency-operation-definition\" aria-label=\"frequency operation definition permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Frequency Operation Definition</h4>\n<p>After defining the correct frequency configuration in the <code class=\"language-text\">lmic_project_config.h</code> file, it is set by default in the code. This means any sketch that uses the library will use this frequency. Remember, this was the setting that we configured in the <code class=\"language-text\">lmic_project_config.h</code> file. However, some configuration is still required. I added an else if statement to the existing statements in the <code class=\"language-text\">setup</code> function - which had an existing configuration for the EU868 and US915 frequency plans. However, there was no additional code for the AU915 frequency. </p>\n<p>Specifically, the <code class=\"language-text\">setup()</code> function in the sketch performs a check to see what regional configuration is set in the <em>Arduino-LMIC</em> code and performs additional configuration; for example, setting specific channels.  A snippet from the original example sketch is provided below for reference. You can see that only the EU868 and US915 frequencies are further configured here.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">void</span> <span class=\"token function\">setup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>CFG_eu868<span class=\"token punctuation\">)</span></span></span>\n    <span class=\"token function\">LMIC_setupChannel</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">868100000</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DR_RANGE_MAP</span><span class=\"token punctuation\">(</span>DR_SF12<span class=\"token punctuation\">,</span> DR_SF7<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  BAND_CENTI<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// g-band</span>\n    <span class=\"token function\">LMIC_setupChannel</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">868300000</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DR_RANGE_MAP</span><span class=\"token punctuation\">(</span>DR_SF12<span class=\"token punctuation\">,</span> DR_SF7B<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> BAND_CENTI<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// g-band</span>\n    <span class=\"token function\">LMIC_setupChannel</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">868500000</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DR_RANGE_MAP</span><span class=\"token punctuation\">(</span>DR_SF12<span class=\"token punctuation\">,</span> DR_SF7<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  BAND_CENTI<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// g-band</span>\n    <span class=\"token function\">LMIC_setupChannel</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">867100000</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DR_RANGE_MAP</span><span class=\"token punctuation\">(</span>DR_SF12<span class=\"token punctuation\">,</span> DR_SF7<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  BAND_CENTI<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// g-band</span>\n    <span class=\"token function\">LMIC_setupChannel</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">867300000</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DR_RANGE_MAP</span><span class=\"token punctuation\">(</span>DR_SF12<span class=\"token punctuation\">,</span> DR_SF7<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  BAND_CENTI<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// g-band</span>\n    <span class=\"token function\">LMIC_setupChannel</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">867500000</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DR_RANGE_MAP</span><span class=\"token punctuation\">(</span>DR_SF12<span class=\"token punctuation\">,</span> DR_SF7<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  BAND_CENTI<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// g-band</span>\n    <span class=\"token function\">LMIC_setupChannel</span><span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">867700000</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DR_RANGE_MAP</span><span class=\"token punctuation\">(</span>DR_SF12<span class=\"token punctuation\">,</span> DR_SF7<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  BAND_CENTI<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// g-band</span>\n    <span class=\"token function\">LMIC_setupChannel</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">867900000</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DR_RANGE_MAP</span><span class=\"token punctuation\">(</span>DR_SF12<span class=\"token punctuation\">,</span> DR_SF7<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  BAND_CENTI<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// g-band</span>\n    <span class=\"token function\">LMIC_setupChannel</span><span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">868800000</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DR_RANGE_MAP</span><span class=\"token punctuation\">(</span>DR_FSK<span class=\"token punctuation\">,</span>  DR_FSK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  BAND_MILLI<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// g2-band</span>\n    <span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">elif</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>CFG_us915<span class=\"token punctuation\">)</span></span></span>\n    <span class=\"token function\">LMIC_selectSubBand</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>Note how the US915 frequency is configured to only use sub-band 2. This is configured by the line: <code class=\"language-text\">LMIC_selectSubBand(1);</code>. This is a simple function provided by the library to only enable a specific set of channels, called a sub-band. </p>\n<p>So basically, we need to perform additional configuration of the frequency we have chosen. So far I have been discussing AU915 (or AU921 as MCCI called it). The following code addition forces only the AU915 sub-band 2 to be specified. This means that only the channels in sub-band 2 will be enabled, and all other channels will be disabled.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Modifications to operate on AU915 sub-band 2</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">elif</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>CFG_au921<span class=\"token punctuation\">)</span></span></span>\nSerial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token function\">F</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Loading AU915 Configuration...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">LMIC_selectSubBand</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Set to AU915 sub-band 2</span></code></pre></div>\n<p>The above code is relatively straightforward - thanks to MCCI who wrote some nice definitions and methods for the frequency. It is important to note that this function requires the sub-band required to be <em>one less</em> that the actual sub-band required.</p>\n<p>NOTE: This modification has already been made in the <code class=\"language-text\">Dragino_MCCI_ABP_AU915.ino</code> sketch file, so no changes are required. </p>\n<h4 id=\"dragino-lora-shield-pin-mapping\" style=\"position:relative;\"><a href=\"#dragino-lora-shield-pin-mapping\" aria-label=\"dragino lora shield pin mapping permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dragino LoRa Shield Pin Mapping</h4>\n<p>The pin mapping configuration that was supplied with the original sketch file was for the <a href=\"https://www.adafruit.com/products/3178\">Adafruit Feather M0 LoRa</a>, which is the same configuration used for the <a href=\"https://store.mcci.com/collections/lorawan-iot-and-the-things-network/products/catena-4450-lorawan-iot-device\">MCCI Catena 4450</a> and <a href=\"https://store.mcci.com/collections/lorawan-iot-and-the-things-network/products/catena-4460-sensor-wing-w-bme680\">Catena 4460</a> products. However, we want to set the pin mappings for the Dragino LoRa Shield. We need to set the ping mapping to the following values. </p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Pin mapping for Dragino LoRa Shield</span>\n<span class=\"token keyword\">const</span> lmic_pinmap lmic_pins <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span>nss <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">.</span>rxtx <span class=\"token operator\">=</span> LMIC_UNUSED_PIN<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">.</span>rst <span class=\"token operator\">=</span> <span class=\"token number\">9</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">.</span>dio <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>NOTE: This modification has already been made in the <code class=\"language-text\">Dragino_MCCI_ABP_AU915.ino</code> sketch file, so no changes are required. </p>\n<h4 id=\"setting-the-abp-keys-and-device-address\" style=\"position:relative;\"><a href=\"#setting-the-abp-keys-and-device-address\" aria-label=\"setting the abp keys and device address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Setting the ABP Keys and Device Address</h4>\n<p>Make sure you remember to <strong>change the ABP properties in the sketch file</strong>. You need to replace the <code class=\"language-text\">FILLMEIN</code> placeholders with the network session key, application session key and device address. The block of code is displayed for reference below.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// LoRaWAN NwkSKey, network session key</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">const</span> PROGMEM <span class=\"token class-name\">u1_t</span> NWKSKEY<span class=\"token punctuation\">[</span><span class=\"token number\">16</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> FILLMEIN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// LoRaWAN AppSKey, application session key</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">u1_t</span> PROGMEM APPSKEY<span class=\"token punctuation\">[</span><span class=\"token number\">16</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> FILLMEIN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// LoRaWAN end-device address (DevAddr)</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">u4_t</span> DEVADDR <span class=\"token operator\">=</span> FILLMEIN<span class=\"token punctuation\">;</span> <span class=\"token comment\">// &lt;-- Change this address for every node!</span></code></pre></div>\n<p>NOTE: <strong>This modification has not been made in the <code class=\"language-text\">Dragino_MCCI_ABP_AU915.ino</code> sketch file</strong>, so you must make these changes. </p>\n<h4 id=\"checking-functionality\" style=\"position:relative;\"><a href=\"#checking-functionality\" aria-label=\"checking functionality permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Checking Functionality</h4>\n<p>Now that all the modifications have been made, we can compile and upload the sketch to the Arduino Uno. All you need to do is hit the <em>Upload</em> button in the Arduino IDE to compile, then load the sketch onto the device. Make sure you have the correct COM port selected. The sketch configured that the Serial Monitor is set to <code class=\"language-text\">115200</code>. So open by navigating to <em>Tools</em>, <em>Serial Monitor</em> and set the baud to <code class=\"language-text\">115200</code>. You should see output similar to the listing below:</p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">Starting\nLoading AU915 Configuration...\n6853: EV_TXSTART\nPacket queued\nSending packet on frequency:917400000\n256551: EV_TXCOMPLETE (includes waiting for RX windows)\n4006984: EV_TXSTART\nPacket queued\nSending packet on frequency:916800000\n4277002: EV_TXCOMPLETE (includes waiting for RX windows)\n8027439: EV_TXSTART\nPacket queued\nSending packet on frequency:917200000\n8275202: EV_TXCOMPLETE (includes waiting for RX windows)</code></pre></div>\n<p>Notice how we are sending packets on the correct AU915 channels including: <code class=\"language-text\">917.4</code>, <code class=\"language-text\">917.2</code> and <code class=\"language-text\">916.8</code>. I confirmed the device was working correctly by checking our LoRaWAN gateway packet forwarder logs. I also checked that the data was getting to the server, but subscribing to the MQTT topic for the node I added and could see <code class=\"language-text\">SGVsbG8sIHdvcmxkIQ==</code> in the data fields of the JSON, easily decoded from base64 to: <code class=\"language-text\">Hello, world!</code>, as specified in the sketch file code.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>This post covered another method for getting the Dragino LoRa Shield to work with the Australian and New Zealand LoRaWAN frequency using the MCCI Arudino-LMIC library. I think the library is a good solution and implements the AU915 (what they call AU921) correctly. It is a much more elegant approach than my <em>hacky</em> fix to the original Arduino-LMIC library, and recommend to anyone who wants to configure a LoRaWAN node on an Arduino-based device such as the Dragino LoRa Shield or similar Arduino-based device.</p>\n<p>If you have any feedback or questions please post a comment below. Also, if anyone knows any other Arduino-LMIC or LoRaWAN libraries that they like for LoRaWAN nodes, please feel free to share them below in the comments. Thanks!</p>","frontmatter":{"title":"Dragino LoraShield on AU915","date":"July 21, 2018","tags":["IoT","LoRaWAN","AU915"],"description":"Tutorial on how to configure the Dragino LoRa Shield device for the Australian/New Zealand (AU915) frequency.","thumbnail":"lorawan.png"}},"previous":{"fields":{"slug":"/blog/2018-07-18/scripting-vrealize-automation-using-powershell/"},"frontmatter":{"title":"Scripting vRealize Automation using PowerShell"}},"next":{"fields":{"slug":"/blog/2018-09-07/restricting-ssh-access-using-rssh/"},"frontmatter":{"title":"Restricting SSH Access using rssh"}}},"pageContext":{"id":"0980df65-e66b-535b-994e-530228c9a215","previousPostId":"1d924a8b-72fa-5ea8-bdd5-77954bfe411e","nextPostId":"6755c232-5eee-5895-a189-53192f60f8d1"}},"staticQueryHashes":["1771194231","2841359383","3880320062"]}